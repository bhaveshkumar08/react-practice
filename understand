import React, { useState, useRef, useEffect } from 'react';
import { useSelector } from 'react-redux';
import 'styles/m-scss/components/listing26/c-stickycallbanner.scss';
import StickySeniorCallBanner from './StickySeniorCallBanner';
import StickyCallCouponBanner from './StickyCallCouponBanner';
import StickyCallBanner from './StickyCallBanner';
import StickyChatBanner from './StickyChatBanner';
import { getDataFromSessionStorage, saveInSessionStorage } from 'utils/storageHelper';

const StickyBanner = () => {
    const { AkamaiCountryCode, criteria, dynamicPhoneNumber } = useSelector(mapStateToProps);
    const [isBannerClosed, setIsBannerClosed] = useState(true);
    const showStickyBannerObserver = useRef<IntersectionObserver | null>(null);
    const hideStickyBannerObserver = useRef<IntersectionObserver | null>(null);
    const isSenior = criteria.numTravelers.Total === criteria.numTravelers.seniors;
    const { CountrySpecificTfn, ExcludedPromo, ShowCallOnlyCouponBanner, enableChatSdk, enableChatForIframe } = window.cockpitSetting?.ApplicationSettings ?? {};
    const displayCallBanner = CountrySpecificTfn?.includes(AkamaiCountryCode) ?? false;
    const callPromoCodeContent = ExcludedPromo ? JSON.parse(ExcludedPromo) : null;
    const callCouponCodeOnStickyBanner = callPromoCodeContent?.code && ShowCallOnlyCouponBanner;
    const isChatEnabled = enableChatSdk && (enableChatForIframe || window.location === window.parent.location);
    const resources = window.iLn.ListingResources;

    useEffect(() => {
        setStickyBanner();
        return(() => {
            window.stickyBannerScrollObserver = false;
            window.stickyBannerScrollObserverClose = false;
            showStickyBannerObserver.current?.disconnect();
            hideStickyBannerObserver.current?.disconnect();
        })
    }, [])
    const setStickyBanner = () => {
        getDataFromSessionStorage("closedStickyCallBanner").then((closedStickyCallBanner) => {
            if(!closedStickyCallBanner) {
                showStickyBannerIntersectionObservere("#contractindex_4");
            }
        });
    }
    const showStickyBannerIntersectionObservere = (selector: string) => {
        try {
            showStickyBannerObserver.current?.disconnect();

            const target = document.querySelector(selector);
            if (!target) return;

            showStickyBannerObserver.current = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting && !window.stickyBannerScrollObserver ) {
                    setIsBannerClosed(false);
                    setTimeout(() => { closeStickyBannerIntersectionObserver("#contractindex_1")}, 1000);
                    window.stickyBannerScrollObserver = true;
                }
            }, { threshold: .5});

            showStickyBannerObserver.current.observe(target);
        }
        catch { }
    }
    const closeStickyBannerIntersectionObserver = (selector: string) => {
        try {
            hideStickyBannerObserver.current?.disconnect();

            const target = document.querySelector(selector);
            if (!target) return;

            hideStickyBannerObserver.current = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting && !window.stickyBannerScrollObserverClose) {
                    setIsBannerClosed(true);
                    window.stickyBannerScrollObserver = false;
                }
            }, { threshold: 1 });
            
            hideStickyBannerObserver.current.observe(target);
        }
        catch { }
    }
    const closeBanner = () => {
        setIsBannerClosed(true);
        saveInSessionStorage("closedStickyCallBanner", true);
        window.stickyBannerScrollObserver = true;
        window.stickyBannerScrollObserverClose = true;
        showStickyBannerObserver.current?.disconnect();
        hideStickyBannerObserver.current?.disconnect();
    };

    if (isBannerClosed) return null;

    if (displayCallBanner) {
        if (isSenior) 
            return <StickySeniorCallBanner dynamicPhoneNumber={dynamicPhoneNumber} closeBanner={closeBanner} />;
        if (callCouponCodeOnStickyBanner)
            return <StickyCallCouponBanner dynamicPhoneNumber={dynamicPhoneNumber} callPromoCodeContent={callPromoCodeContent} resources={resources} closeBanner={closeBanner} />;
        return <StickyCallBanner dynamicPhoneNumber={dynamicPhoneNumber} closeBanner={closeBanner} />;
    }

    if (isChatEnabled) 
        return <StickyChatBanner closeBanner={closeBanner}/>;

    return null;
}
const mapStateToProps = (state) => ({
   AkamaiCountryCode: state.airContext.AkamaiCountryCode,
   criteria: state.airListing.listing.criteria,
   dynamicPhoneNumber: state.userActivity.dynamicPhoneNumber
});

export default StickyBanner
